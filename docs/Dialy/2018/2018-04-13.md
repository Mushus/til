# Akamaiにはキャッシュが２つあるっぽい

[Akamai](https://www.akamai.com/) は CDN です。  
中国に会社を持っている企業が中国でWebサイトを展開する場合、政府に認可してもらう必要があります。それがICP登録です。配信停止とか罰金があるとか…。  
中国展開する場合、AkamaiのCDNを経由して配信することで、中国にサーバーがなくてもICP登録が可能です。(できるけど保証はしてないらしい)  

Akamai でURLごとなどでキャッシュの設定をすることでオリジンサーバーの負荷軽減することができます。  
コンテンツを動的に生成するが、頻繁な更新を要さない場合や静的ファイルを配信する場合にとても効果的です。  

ただ、このキャッシュの設定を行っていないのにもかかわらず、更新がなかなかされない画像がありました。  
結論から言うと上記のキャッシュの設定を指定なくても別にキャッシュが聞くようになっているみたいです。  
ブラウザからURLでリクエストを送る時に特定の条件でキャッシュを使用するかをサーバーに確認を取る `If-Modified-Since` ヘッダーが発行される時があります。  
Akamai にブラウザからリクエストする際、ブラウザがヘッダーを付けてるかどうかににかかわらず Akamai がそのヘッダーを勝手に付加して、ステータスコードの `304` が帰ってきている場合は Akamai 自体がキャッシュを返します。  

今回、こんな問題がありました。  
PHPで画像を動的生成していましたが、適切にキャッシュをしてもらうためにDBに画像の更新日時を格納し、レスポンスに応じて `304` をなるべく返す設計になっていました。  
本番環境と憲章環境を同一の状態にするために、本番環境のバックアップから検証環境のDBを構築し直す作業をしたのですが、検証環境の画像がなかなか反映されませんでした。  
検証環境なので当然 Akamai のキャッシュは切ってるはずなのですが更新されないみたいな変な状態でした。  
ソースを追った限り問題は 304 のレスポンスを返すところしか無かったので、実際に検証したらそうだったという感じです。。。

ちなみに Akamai には First Purge というキャッシュを強制的に揮発させる機能があるのですが、それもどうやらこのキャッシュには効かないみたいです。。。

キャッシュの設定をしてないはずなのにCDN側にキャッシュが残ってる状態ってなんかなぁ。。。
